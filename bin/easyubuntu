#!/usr/bin/env bash
set -euo pipefail

EASYUBUNTU_VERSION="0.1.0"

err() { printf "easyubuntu: %s\n" "$*" >&2; }

resolve_lib_root() {
  # Dev mode: repo checkout
  local self_dir
  self_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
  if [[ -f "$self_dir/../lib/ui.sh" && -f "$self_dir/../lib/desktop.sh" ]]; then
    (cd -- "$self_dir/.." && pwd)
    return 0
  fi

  # Installed mode
  local data_home="${XDG_DATA_HOME:-$HOME/.local/share}"
  local installed_root="$data_home/easyubuntu"
  if [[ -f "$installed_root/lib/ui.sh" && -f "$installed_root/lib/desktop.sh" ]]; then
    printf "%s\n" "$installed_root"
    return 0
  fi

  return 1
}

LIB_ROOT="$(resolve_lib_root || true)"
if [[ -z "${LIB_ROOT:-}" ]]; then
  err "Could not locate installed libraries."
  err "If you installed via ./install.sh, try re-running it."
  exit 1
fi

# shellcheck source=/dev/null
source "$LIB_ROOT/lib/ui.sh"
# shellcheck source=/dev/null
source "$LIB_ROOT/lib/desktop.sh"
# shellcheck source=/dev/null
source "$LIB_ROOT/lib/apparmor.sh"

export EASYUBUNTU_VERSION

main_menu() {
  while true; do
    local choice
    ui_menu "EasyUbuntu $EASYUBUNTU_VERSION" "What would you like to do?" "Select" "Exit" \
      "desktop" "Manage .desktop entries" \
      "apparmor" "Manage AppArmor profiles" \
      "exit" "Exit"
    if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then exit 0; fi
    choice="${UI_RESULT:-}"

    case "$choice" in
      desktop) desktop_menu ;;
      apparmor) apparmor_menu ;;
      exit) exit 0 ;;
      "") continue ;;
      *) ui_error "Unknown choice: $choice" ;;
    esac
  done
}

apparmor_menu() {
  while true; do
    local choice
    ui_menu "Manage AppArmor profiles" "Profiles in $(apparmor_profiles_dir)" "Select" "Back" \
      "create" "Create profile" \
      "remove" "Remove profile" \
      "back" "Back"
    if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then return 0; fi
    choice="${UI_RESULT:-}"

    case "$choice" in
      create) apparmor_ui_create ;;
      remove) apparmor_ui_remove ;;
      back) return 0 ;;
      "") continue ;;
      *) ui_error "Unknown choice: $choice" ;;
    esac
  done
}

apparmor_ui_create() {
  # Flow:
  # 1) pick desktop
  # 2) profile name (slugified Name)
  # 3) exec path (prefilled from Exec)
  # 4) permissions lines (editable list)
  # 5) review, then sudo write + load + reload
  desktop_pick_entry
  if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then return 0; fi
  local desktop_path
  desktop_path="${UI_RESULT:-}"
  desktop_path="$(trim "$desktop_path")"
  [[ -n "$desktop_path" ]] || return 0

  local app_name exec_line default_exec_path
  app_name="$(desktop_entry_name "$desktop_path")"
  exec_line="$(desktop_entry_exec "$desktop_path")"
  default_exec_path="$(desktop_extract_first_absolute_path_from_exec "$exec_line")"

  local step=0
  local profile_name="" exec_path="" perms_lines=""

  profile_name="$(apparmor_slugify_name "$app_name")"
  exec_path="$default_exec_path"
  perms_lines="$(apparmor_permissions_default)"

  while true; do
    case "$step" in
      0)
        ui_input "AppArmor" "Profile filename (under /etc/apparmor.d/)" "$profile_name" "Next" "Back"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then return 0; fi
        profile_name="$(apparmor_slugify_name "$(trim "${UI_RESULT:-}")")"
        if [[ -z "$profile_name" ]]; then ui_error "Profile name cannot be empty."; continue; fi
        step=1
        ;;

      1)
        ui_input "AppArmor" "Executable full path (from Exec; editable)" "$exec_path" "Next" "Back"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then step=0; continue; fi
        exec_path="$(trim "${UI_RESULT:-}")"
        if [[ -z "$exec_path" ]]; then
          ui_error "Executable path cannot be empty."
          continue
        fi
        step=2
        ;;

      2)
        # Permissions editor: show current, add/remove/done.
        ui_textbox "AppArmor permissions" "Current permissions lines:\n\n$perms_lines" "Continue"
        ui_menu "AppArmor permissions" "Edit permissions block" "Select" "Back" \
          "add" "Add a permission line" \
          "remove_last" "Remove last line" \
          "done" "Done"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then step=1; continue; fi
        case "${UI_RESULT:-}" in
          add)
            ui_input "AppArmor permissions" "Enter a line (e.g. userns,)" "" "Add" "Back"
            if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then continue; fi
            local line
            line="$(trim "${UI_RESULT:-}")"
            if [[ -n "$line" ]]; then
              perms_lines+="$line"$'\n'
            fi
            ;;
          remove_last)
            # Remove last non-empty line.
            perms_lines="$(printf "%s" "$perms_lines" | sed '$d')"$'\n'
            ;;
          done)
            step=3
            ;;
          *)
            ;;
        esac
        ;;

      3)
        local perms_block profile_text target_path
        perms_block="$(apparmor_permissions_join "$perms_lines")"
        profile_text="$(apparmor_generate_profile_text "$exec_path" "$perms_block" "$desktop_path" "$exec_line")"
        target_path="$(apparmor_profile_path "$profile_name")"

        ui_textbox "Review AppArmor profile" "Target:\n$target_path\n\n$profile_text" "Back"
        ui_yesno "Save AppArmor profile" "Write and load this profile?\n\n$target_path" "Save" "Back"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then step=2; continue; fi
        if ! apparmor_write_profile "$profile_name" "$profile_text"; then
          step=2
          continue
        fi
        if ! apparmor_load_and_reload "$profile_name"; then
          return 0
        fi
        return 0
        ;;
      *)
        return 0
        ;;
    esac
  done
}

apparmor_ui_remove() {
  apparmor_pick_managed_profile
  if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then return 0; fi
  local profile_path
  profile_path="${UI_RESULT:-}"
  profile_path="$(trim "$profile_path")"
  [[ -n "$profile_path" ]] || return 0

  if ui_yesno "Remove AppArmor profile" "Delete:\n\n$profile_path\n\nThen reload AppArmor." "Delete" "Back"; then
    apparmor_remove_profile "$profile_path"
  fi
  return 0
}

desktop_menu() {
  while true; do
    local choice
    ui_menu "Manage .desktop entries" "User applications: $(desktop_user_dir)" "Select" "Back" \
      "list" "List entries" \
      "create" "Create new entry" \
      "import" "Import existing .desktop file" \
      "remove" "Remove entry" \
      "back" "Back"
    if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then return 0; fi
    choice="${UI_RESULT:-}"

    case "$choice" in
      list) desktop_ui_list ;;
      create) desktop_ui_create ;;
      import) desktop_ui_import ;;
      remove) desktop_ui_remove ;;
      back) return 0 ;;
      "") continue ;;
      *) ui_error "Unknown choice: $choice" ;;
    esac
  done
}

desktop_ui_list() {
  local content
  content="$(desktop_list_pretty)"
  ui_textbox "Installed .desktop entries" "$content" "Back"
  # Esc behaves like Back
}

desktop_ui_create() {
  local step=0

  local container_dir="" name="" prefix="" rel_path="" full_path="" exec=""
  local icon="" comment="" categories="Utility;" terminal="false" filename=""

  while true; do
    case "$step" in
      0)
        ui_input "Create .desktop" "Container folder directory path" "$container_dir" "Next" "Back"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then return 0; fi
        container_dir="$(trim "${UI_RESULT:-}")"
        if [[ -z "$container_dir" ]]; then ui_error "Container folder cannot be empty."; continue; fi
        if [[ ! -d "$container_dir" ]]; then ui_error "Not a directory: $container_dir"; continue; fi
        step=1
        ;;

      1)
        ui_input "Create .desktop" "Name" "${name:-$(basename -- "$container_dir")}" "Next" "Back"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then step=0; continue; fi
        name="$(trim "${UI_RESULT:-}")"
        if [[ -z "$name" ]]; then ui_error "Name cannot be empty."; continue; fi
        step=2
        ;;

      2)
        ui_input "Create .desktop" "Prefix to run (optional, e.g. npx)" "$prefix" "Next" "Back"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then step=1; continue; fi
        prefix="$(trim "${UI_RESULT:-}")"
        step=3
        ;;

      3)
        ui_input "Create .desktop" "Relative path to run (inside container folder)" "$rel_path" "Next" "Back"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then step=2; continue; fi
        rel_path="$(trim "${UI_RESULT:-}")"
        if [[ -z "$rel_path" ]]; then ui_error "Relative path cannot be empty."; continue; fi
        if [[ "$rel_path" == /* ]]; then ui_error "Relative path must not start with /"; continue; fi
        rel_path="${rel_path#./}"

        full_path="$container_dir/$rel_path"
        while [[ "$full_path" == *"//"* ]]; do full_path="${full_path//\/\///}"; done

        if [[ -n "$prefix" ]]; then
          exec="$prefix $full_path"
        else
          exec="$full_path"
        fi

        if [[ ! -e "$full_path" ]]; then
          if ! ui_yesno "Create .desktop" "Target path does not exist:\n\n$full_path\n\nContinue anyway?" "Continue" "Back"; then
            # No/Back or Esc => edit relative path again
            step=3
            continue
          fi
        fi

        step=4
        ;;

      4)
        desktop_choose_icon_from_container "$container_dir"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then step=3; continue; fi
        icon="${UI_RESULT:-}"
        if [[ -n "$icon" ]]; then
          step=5
        else
          # User skipped auto icon (or none found) -> allow optional manual icon.
          step=41
        fi
        ;;

      41)
        ui_input "Create .desktop" "Icon (optional: absolute path or icon name)" "$icon" "Next" "Back"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then step=4; continue; fi
        icon="$(trim "${UI_RESULT:-}")"
        # If it looks like a path, best-effort validate existence.
        if [[ -n "$icon" && "$icon" == *"/"* && ! -e "$icon" ]]; then
          ui_error "Icon path not found: $icon"
          continue
        fi
        step=5
        ;;

      5)
        ui_input "Create .desktop" "Comment (optional)" "$comment" "Next" "Back"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then
          # If user went through manual icon step, go back there; else go back to auto icon.
          if [[ -z "${icon:-}" ]]; then step=41; else step=4; fi
          continue
        fi
        comment="${UI_RESULT:-}"
        step=6
        ;;

      6)
        ui_input "Create .desktop" "Categories (optional, e.g. Utility;System;)" "$categories" "Next" "Back"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then step=5; continue; fi
        categories="${UI_RESULT:-}"
        step=7
        ;;

      7)
        ui_menu "Create .desktop" "Run in terminal?" "Next" "Back" \
          "false" "No" \
          "true" "Yes"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then step=6; continue; fi
        terminal="${UI_RESULT:-false}"
        step=8
        ;;

      8)
        if [[ -z "$filename" ]]; then
          filename="$(desktop_suggest_filename "$name")"
        fi
        ui_input "Create .desktop" "Filename (will be placed in $(desktop_user_dir))" "$filename" "Next" "Back"
        if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then step=7; continue; fi
        filename="$(trim "${UI_RESULT:-}")"
        if [[ -z "$filename" ]]; then ui_error "Filename cannot be empty."; continue; fi
        if [[ "$filename" != *.desktop ]]; then filename="$filename.desktop"; fi
        step=9
        ;;

      9)
        local summary
        summary="Name: $name\nExec: $exec\nIcon: ${icon:-<none>}\nTerminal: $terminal\nCategories: ${categories:-<none>}\nFile: $(desktop_user_dir)/$filename\n"
        if ui_yesno "Create .desktop" "Create this entry?\n\n$summary" "Save" "Back"; then
          if desktop_create_entry "$filename" "$name" "$exec" "$icon" "$comment" "$categories" "$terminal"; then
            ui_msg "Created" "Created: $(desktop_user_dir)/$filename"
            return 0
          fi
          ui_error "Failed to create entry."
          step=8
        else
          step=8
        fi
        ;;

      *)
        return 0
        ;;
    esac
  done
}

desktop_ui_import() {
  local src filename
  ui_input "Import .desktop" "Path to an existing .desktop file" "" "Next" "Back"
  if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then return 0; fi
  src="$(trim "${UI_RESULT:-}")"
  src="$(trim "$src")"

  if [[ -z "$src" ]]; then ui_error "Path cannot be empty."; return 0; fi
  if [[ ! -f "$src" ]]; then ui_error "File not found: $src"; return 0; fi
  if ! desktop_is_desktop_file "$src"; then ui_error "File does not look like a .desktop entry."; return 0; fi

  filename="$(basename -- "$src")"
  ui_input "Import .desktop" "Destination filename" "$filename" "Import" "Back"
  if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then return 0; fi
  filename="$(trim "${UI_RESULT:-}")"
  if [[ -z "$filename" ]]; then ui_error "Filename cannot be empty."; return 0; fi
  if [[ "$filename" != *.desktop ]]; then filename="$filename.desktop"; fi

  if desktop_import_entry "$src" "$filename"; then
    ui_msg "Imported" "Imported to: $(desktop_user_dir)/$filename"
  else
    ui_error "Failed to import entry."
  fi
}

desktop_ui_remove() {
  local file

  desktop_pick_entry
  if [[ "${UI_CANCELLED:-0}" -eq 1 ]]; then
    return 0
  fi
  file="${UI_RESULT:-}"
  file="$(trim "$file")"
  if [[ -z "$file" ]]; then
    return 0
  fi

  if ui_yesno "Remove .desktop" "Delete $(basename -- "$file")?\n\nThis cannot be undone." "Delete" "Back"; then
    if desktop_remove_entry "$file"; then
      ui_msg "Removed" "Removed: $file"
    else
      ui_error "Failed to remove entry."
    fi
  else
    # No/Back or Esc => back to Manage menu.
    return 0
  fi
}

main_menu

